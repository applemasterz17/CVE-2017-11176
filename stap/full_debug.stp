%{
	#include <net/sock.h>
	#include <linux/fdtable.h> 
%}

global sock_ptr = 0;

function dump_netlink_sock:long (arg_sock:long)
%{
	struct netlink_ring {
			void                    **pg_vec;
			unsigned int            head;
			unsigned int            frames_per_block;
			unsigned int            frame_size;
			unsigned int            frame_max;
			unsigned int            pg_vec_order;
			unsigned int            pg_vec_pages;
			unsigned int            pg_vec_len;
			atomic_t                pending;
	};

	struct netlink_sock {
			struct sock             sk;
			u32                     portid;
			u32                     dst_portid;
			u32                     dst_group;
			u32                     flags;
			u32                     subscriptions;
			u32                     ngroups;
			unsigned long           *groups;
			unsigned long           state;
			size_t                  max_recvmsg_len;
			wait_queue_head_t       wait;
			bool                    cb_running;
			struct netlink_callback cb;
			struct mutex            *cb_mutex;
			struct mutex            cb_def_mutex;
			void                    (*netlink_rcv)(struct sk_buff *skb);
			int                     (*netlink_bind)(int group);
			void                    (*netlink_unbind)(int group);
			struct module           *module;
	};

	struct sock *sk = (void*) STAP_ARG_arg_sock;
	struct netlink_sock *nlk = (void*) sk;

	_stp_printf("-={ dump_netlink_sock: %p }=-\n", nlk);
	_stp_printf("- sk = %p\n", sk);
	_stp_printf("- sk->sk_rmem_alloc = %d\n", sk->sk_rmem_alloc);
	_stp_printf("- sk->sk_rcvbuf = %d\n", sk->sk_rcvbuf);
	_stp_printf("- sk->sk_refcnt = %d\n", sk->sk_refcnt);
	_stp_printf("-={ dump_netlink_sock: END}=-\n");

%}


///////////////////////// mq_notify ////////////////////////
probe syscall.mq_notify
{
	if(execname() == "test")
	{
		printf("\n\n(%d-%d) [SYSCALL] ==>> mq_notify (%s)\n", pid(), tid(), argstr)
	}
}

probe syscall.mq_notify.return
{
	if(execname() == "test")
	{
		if(sock_ptr != 0)
		{
			dump_netlink_sock(sock_ptr);
			sock_ptr = 0;
		}
		printf("(%d-%d) [SYSCALL] <<== mq_notify = %x\n\n\n", pid(), tid(), $return)
	}
}

//////////////////////// fdget ////////////////////////
probe kernel.function ("fdget")
{
	if(execname() == "test")
	{
		printf("(%d-%d) [vfs] ==>> fdget (%s)\n", pid(), tid(), $$parms)
	}
}


//////////////////////// netlink_getsockbyfilp ////////////////////////
probe kernel.function ("netlink_getsockbyfilp")
{
	if(execname() == "test")
	{
		printf("(%d-%d) [netlink] ==> netlink_getsockbyfilp (%s)\n", pid(), tid(), $$parms)
	}
}
probe kernel.function ("netlink_getsockbyfilp").return
{
	if(execname() == "test")
	{
		printf("(%d-%d) [netlink] <== netlink_getsockbyfilp = %x\n", pid(), tid(), $return)
		sock_ptr = $return;
	}
}

//////////////////////// netlink_attachskb ////////////////////////
probe kernel.function ("netlink_attachskb")
{
	if(execname() == "test")
	{
		printf("(%d-%d) [netlink] ==> netlink_attachskb (%s)\n", pid(), tid(), $$parms)
	}
}
probe kernel.function ("netlink_attachskb").return
{
	if(execname() == "test")
	{
		printf("(%d-%d) [netlink] <== netlink_attachskb = %x\n", pid(), tid(), $return)
}

//////////////////////// netlink_detachskb ////////////////////////
probe kernel.function ("netlink_detachskb")
{
	if(execname() == "test")
	{
		printf("(%d-%d) [netlink] ==> netlink_detachskb (%s)\n", pid(), tid(), $$parms)
	}
}
probe kernel.function ("netlink_detachskb").return
{
	if(execname() == "test")
	{
		printf("(%d-%d) [netlink] <== netlink_detachskb\n", pid(), tid())
	}
}
