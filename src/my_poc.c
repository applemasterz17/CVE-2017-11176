#define _GNU_SOURCE
#include <asm/types.h>
#include <mqueue.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <linux/netlink.h>
#include <pthread.h>
#include <errno.h>
#include <stdbool.h>

#define NOTIFY_COOKIE_LEN (32)
#define SOL_NETLINK (270) // from [include/linux/socket.h]

#define _mq_notify(mqdes, sevp) syscall(__NR_mq_notify, mqdes, sevp)
#define _socket(domain, type, protocol) syscall(__NR_socket, domain, type, protocol)
#define _setsockopt(sockfd, level, optname, optval, optlen) \
    syscall(__NR_setsockopt, sockfd, level, optname, optval, optlen)
#define _getsockopt(sockfd, level, optname, optval, optlen) \
    syscall(__NR_getsockopt, sockfd, level, optname, optval, optlen)
#define _dup(oldfd) syscall(__NR_dup, oldfd)
#define _close(fd) syscall(__NR_close, fd)
#define _sendmsg(sockfd, msg, flags) syscall(__NR_sendmsg, sockfd, msg, flags)
#define _bind(sockfd, addr, addrlen) syscall(__NR_bind, sockfd, addr, addrlen)

struct unblock_thread_arg
{
    int sock_fd;
    int unblock_fd;
    bool is_ready;
};

static void *unblock_thread(void *arg)
{
    return NULL;
}

static int decrease_sock_refcounter(int sock_fd, int unblock_fd)
{
    /*  */
    /*  */
fail:
    printf("[-] Failed to decrease sock refcounter\n");
}

static int prepare_blocking_socket(void)
{
    /* 1. Receiver, Sender 소켓 생성 */₩
    /* 2. Receiver 소켓버퍼 Flooding */
fail:
    printf("[-] Failed to prepare blcok socket\n");
}

int main()
{
    int sock_fd = -1;
    int sock_fd2 = -1;
    int unblock_fd = 1;

    /* 1. Receiver, Sender 소켓 생성, Receiver 의 소켓 버퍼를 Flooding */

    /* 2. Receiver 의 소켓을 dup() 으로 복제 (2개) */

    /* 3. mq_notify() 호출 두번, sock refcnt 를 2번 drop */

    /* 4. Exploit 작성  */

    return 0;

fail:
    printf("[-] Exploit Failed!! \n");
    return -1;
}